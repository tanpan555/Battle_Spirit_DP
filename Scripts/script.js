let test_deck = [{"cid_id":1,"card_id":"1","card_name":"The SunConcluserDragon Apollonia-Vern","card_cost":8,"card_cost_reduct":"red,red,red,god","card_type":"spirit","card_families":"Devotee, Concluser, Astral Dragon","card_image":"SD68-X01","card_color":"red","is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":10000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":3,\"CARD_POWER\":13000},{\"CARD_LEVEL\":3,\"CARD_LEVEL_COST\":5,\"CARD_POWER\":16000}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"console.log('Manifest');\",\"CARD_SKILL_DESC\":\"Flash - Manifest: \\\"Contractor Apollon\\\" & C7 or more (Your Turn)\\r\\nBy sending your  to the Trash, pay one cost from the target to summon this card from the Hand.\",\"CARD_SUMMON_TYPE\":\"manifest\",\"CARD_SUMMON_COND\":\"[{'have_nexus_name : 'Contractor Apollon' },{ 'have_counter_more_equal' : '7'}]\",\"IS_FLASH\":\"Y\"},{\"CARD_LEVEL\":\"1,2,3\",\"CARD_SKILL\":\"console.log('Attack');\",\"CARD_SKILL_DESC\":\"<div class=\\\"row\\\"><div class=\\\"card_ability\\\">Unleash: 2 </div><div class=\\\"EFF_H\\\">[LV1][LV2][LV3] (When Attacks)</div></div>\\r\\n<div class=\\\"EFF_B\\\">\\r\\nDestroy an opposing Spirit/Ultimate with the highest BP, and for each symbol on the destroyed target, send an opposing Life to the Trash. By sending two cores from your Red Grandwalker Nexuses to this Spirit, this destruction effect can't be prevented by opposing effects.</div>\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2,3\",\"CARD_SKILL\":\"console.log('FLASH ATTACK');\",\"CARD_SKILL_DESC\":\"<div class=\\\"row\\\"><div class=\\\"EFF_H\\\">[LV2][LV3] Flash - (When Attacks)</div></div>\\r\\n<div class=\\\"EFF_B\\\">Once per turn, you can negate an opposing active White Magic/Accel effect, other than on-field effects.</div>\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"Y\"}]"},{"cid_id":2,"card_id":"1","card_name":"The SunConcluserDragon Apollonia-Vern","card_cost":8,"card_cost_reduct":"red,red,red,god","card_type":"spirit","card_families":"Devotee, Concluser, Astral Dragon","card_image":"SD68-X01","card_color":"red","is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":10000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":3,\"CARD_POWER\":13000},{\"CARD_LEVEL\":3,\"CARD_LEVEL_COST\":5,\"CARD_POWER\":16000}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"console.log('Manifest');\",\"CARD_SKILL_DESC\":\"Flash - Manifest: \\\"Contractor Apollon\\\" & C7 or more (Your Turn)\\r\\nBy sending your  to the Trash, pay one cost from the target to summon this card from the Hand.\",\"CARD_SUMMON_TYPE\":\"manifest\",\"CARD_SUMMON_COND\":\"[{'have_nexus_name : 'Contractor Apollon' },{ 'have_counter_more_equal' : '7'}]\",\"IS_FLASH\":\"Y\"},{\"CARD_LEVEL\":\"1,2,3\",\"CARD_SKILL\":\"console.log('Attack');\",\"CARD_SKILL_DESC\":\"<div class=\\\"row\\\"><div class=\\\"card_ability\\\">Unleash: 2 </div><div class=\\\"EFF_H\\\">[LV1][LV2][LV3] (When Attacks)</div></div>\\r\\n<div class=\\\"EFF_B\\\">\\r\\nDestroy an opposing Spirit/Ultimate with the highest BP, and for each symbol on the destroyed target, send an opposing Life to the Trash. By sending two cores from your Red Grandwalker Nexuses to this Spirit, this destruction effect can't be prevented by opposing effects.</div>\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2,3\",\"CARD_SKILL\":\"console.log('FLASH ATTACK');\",\"CARD_SKILL_DESC\":\"<div class=\\\"row\\\"><div class=\\\"EFF_H\\\">[LV2][LV3] Flash - (When Attacks)</div></div>\\r\\n<div class=\\\"EFF_B\\\">Once per turn, you can negate an opposing active White Magic/Accel effect, other than on-field effects.</div>\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"Y\"}]"},{"cid_id":3,"card_id":"2","card_name":"The FlameWheelContractor Apollon","card_cost":2,"card_cost_reduct":"red","card_type":"nexus","card_families":"Grandwalker, Olym","card_image":"SD68-CX01","card_color":"red","is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":0,\"CARD_POWER\":null},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":6,\"CARD_POWER\":null}]","card_skills":null},{"cid_id":4,"card_id":"2","card_name":"The FlameWheelContractor Apollon","card_cost":2,"card_cost_reduct":"red","card_type":"nexus","card_families":"Grandwalker, Olym","card_image":"SD68-CX01","card_color":"red","is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":0,\"CARD_POWER\":null},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":6,\"CARD_POWER\":null}]","card_skills":null},{"cid_id":5,"card_id":"3","card_name":"Folk-StarDragon","card_cost":4,"card_cost_reduct":"red,red,god","card_type":"spirit","card_families":"Devotee, Astral Dragon","card_image":"SD68-003","card_color":"red","is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":3000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":2,\"CARD_POWER\":6000}]","card_skills":null},{"cid_id":6,"card_id":"3","card_name":"Folk-StarDragon","card_cost":4,"card_cost_reduct":"red,red,god","card_type":"spirit","card_families":"Devotee, Astral Dragon","card_image":"SD68-003","card_color":"red","is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":3000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":2,\"CARD_POWER\":6000}]","card_skills":null},{"cid_id":7,"card_id":"4","card_name":"Star Dragon Draw","card_cost":3,"card_cost_reduct":"red,red","card_type":"magic","card_families":"Astral Dragon","card_image":"SD68-005","card_color":"red","is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":0,\"CARD_LEVEL_COST\":null,\"CARD_POWER\":null}]","card_skills":null},{"cid_id":8,"card_id":"4","card_name":"Star Dragon Draw","card_cost":3,"card_cost_reduct":"red,red","card_type":"magic","card_families":"Astral Dragon","card_image":"SD68-005","card_color":"red","is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":0,\"CARD_LEVEL_COST\":null,\"CARD_POWER\":null}]","card_skills":null},{"cid_id":9,"card_id":"5","card_name":"WhiteHole Dragon","card_cost":3,"card_cost_reduct":"red,red","card_type":"spirit","card_families":"Astral Dragon","card_image":"SD68-RV002","card_color":"red","is_mirage":"Y","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":3000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":2,\"CARD_POWER\":5000}]","card_skills":null},{"cid_id":10,"card_id":"5","card_name":"WhiteHole Dragon","card_cost":3,"card_cost_reduct":"red,red","card_type":"spirit","card_families":"Astral Dragon","card_image":"SD68-RV002","card_color":"red","is_mirage":"Y","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":3000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":2,\"CARD_POWER\":5000}]","card_skills":null},{"cid_id":11,"card_id":"6","card_name":"The ArdentStarDragon Zon-Balphard","card_cost":5,"card_cost_reduct":"red,red,god","card_type":"spirit","card_families":"Devotee, Astral Dragon","card_image":"SD68-004","card_color":"red","is_mirage":"N","is_burst":"Y","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":4000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":3,\"CARD_POWER\":7000},{\"CARD_LEVEL\":3,\"CARD_LEVEL_COST\":4,\"CARD_POWER\":9000}]","card_skills":null},{"cid_id":12,"card_id":"6","card_name":"The ArdentStarDragon Zon-Balphard","card_cost":5,"card_cost_reduct":"red,red,god","card_type":"spirit","card_families":"Devotee, Astral Dragon","card_image":"SD68-004","card_color":"red","is_mirage":"N","is_burst":"Y","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":4000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":3,\"CARD_POWER\":7000},{\"CARD_LEVEL\":3,\"CARD_LEVEL_COST\":4,\"CARD_POWER\":9000}]","card_skills":null}];
let player1_board ={
    CARD_IN_HAND   : [],
    CARD_IN_BURST  : [],
    CARD_IN_MIRAGE : [],
    CARD_IN_BOARD  : [],
    CARD_IN_DECK   : [],
    CARD_IN_GY     : [],
    CARD_IN_BANISH : [],
};

let player1_core = {
    core_life : 0,
    soul_core_life : 0,
    core_reserve : 0,
    soul_core_reserve : 0,
    core_trash : 0,
    soul_core_trash : 0,
    counter : 0,
};

let coin_result ;

function add_core(p_zone,p_amt){
    const selected_zone = document.querySelector('div[zone="'+p_zone+'"]');
    switch(p_zone){
        case 'LIFE':    player1_core.core_life    += p_amt; break;
        case 'RESERVE': player1_core.core_reserve += p_amt; break;
        case 'COUNTER': player1_core.counter      += p_amt; break;
    }

    if(p_zone == 'RESERVE'){
      if(player1_core.core_reserve <= 6){
        for(let i = 1; i<=p_amt;i++){ 
          selected_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
        }
      }else{
        selected_zone.classList.add("many_core");
        selected_zone.classList.remove("slots");
        while (selected_zone.firstElementChild) {selected_zone.firstElementChild.remove();}
        selected_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
        selected_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+player1_core.core_reserve+'</div>');
      }
    }else if(p_zone == 'LIFE'){
      if(player1_core.core_life <= 6){
        for(let i = 1; i<=p_amt;i++){ 
          selected_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
        }
      }else{
        selected_zone.classList.add("many_core");
        selected_zone.classList.remove("slots");
        while (selected_zone.firstElementChild) {selected_zone.firstElementChild.remove();}
        selected_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
        selected_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+player1_core.core_life+'</div>');
      }
    }
    // load_core();
}

function remove_core(p_zone,p_amt){
   let selected_zone = document.querySelector('div[zone="'+p_zone+'"]');
    if ('LIFE' == p_zone && (player1_core.core_life > 6) && (player1_core.core_life - p_amt <= 6)){
      if(selected_zone.lastElementChild) {
        selected_zone.lastElementChild.remove();
        selected_zone.lastElementChild.remove();
      }
      selected_zone.classList.remove("many_core");
      selected_zone.classList.add("slots");
      for(let i = 0; i<= player1_core.core_life - p_amt;i++){ 
          selected_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
      }
    }else if ('RESERVE' == p_zone && (player1_core.core_reserve > 6) && (player1_core.core_reserve - p_amt <= 6)){
      if(selected_zone.lastElementChild) {
        selected_zone.lastElementChild.remove();
        selected_zone.lastElementChild.remove();
      }
      selected_zone.classList.remove("many_core");
      selected_zone.classList.add("slots");
      for(let i = 0; i<= player1_core.core_reserve - p_amt;i++){ 
          selected_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
      }
    }
   switch(p_zone){
        case 'LIFE':    player1_core.core_life    -= p_amt; break;
        case 'RESERVE': player1_core.core_reserve -= p_amt; break;
        case 'COUNTER': player1_core.counter      -= p_amt; break;
    }
    if(p_zone == 'RESERVE'){
      if(player1_core.core_reserve > 6){
        if(selected_zone.lastElementChild) selected_zone.lastElementChild.remove();
        selected_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+player1_core.core_reserve+'</div>');
      }else{
        for(let i = 1; i<=p_amt;i++){
          if(selected_zone.lastElementChild) selected_zone.lastElementChild.remove();
        }
      }
    }else if(p_zone == 'LIFE'){
      if(player1_core.core_life > 6){
        if(selected_zone.lastElementChild) selected_zone.lastElementChild.remove();
        selected_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+player1_core.core_life+'</div>');
      }else{
        for(let i = 1; i<=p_amt;i++){
          if(selected_zone.lastElementChild) selected_zone.lastElementChild.remove();
        }
      }
    }
}

function set_default_core(){
    player1_core.core_life = 5;
    player1_core.core_reserve = 3;
    player1_core.soul_core_reserve = 1;
    player1_core.counter = 0;
    load_core();
}

function add_card(p_zone,p_card_id){
    const selected_zone = document.querySelector('div[zone="'+p_zone+'"]');
    selected_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" src="images/SLEEVE.png">');
}

function remove_card(p_zone,p_card_id){
   let zone = document.querySelector('div[zone="'+p_zone+'"]');
    if(zone.lastElementChild) zone.lastElementChild.remove();
}

function add_counter(p_value){
    player1_core.counter +=p_value;
    let zone = document.querySelector('[zone="COUNTER"] .COUNTER_NUMBER');   

    if(zone) zone.innerHTML = player1_core.counter;
}

async function get_deck(p_deck_id) {
//   const apiUrl = 'https://oracleapex.com/ords/wksp_rmutttransfer/bst/DECK?DECK_ID=' + p_deck_id;
//   console.log("apiUrl:", apiUrl);
//   try {
//     const response = await fetch(apiUrl, {
//       method: "GET",
//       headers: {"Content-Type": "application/json"}
//     });
//     const data = await response.json();
//     player1_board.CARD_IN_DECK = shuffle(data.items);
//     return shuffle(data.items);
//   } catch (error) {
//     console.error("Error:", error);
//     throw error;
//   }
    test_deck = shuffle(test_deck);
    test_deck.forEach(function(v,i,a){ player1_board.CARD_IN_DECK.push(v); });
    return player1_board.CARD_IN_DECK;
}

function shuffle(sourceArray) {
    for (let i = 0; i < sourceArray.length - 1; i++) {
        let j = i + Math.floor(Math.random() * (sourceArray.length - i));

        let temp = sourceArray[j];
        sourceArray[j] = sourceArray[i];
        sourceArray[i] = temp;
    }
    return sourceArray;
}

async function start_game() {
    player1_board.CARD_IN_DECK = await get_deck(1);
    load_deck(player1_board.CARD_IN_DECK);
    set_default_core();
}

function draw_deck(p_amt){
  p_amt = p_amt || 1;
  for(let i = 1; i<=p_amt;i++){
    if(player1_board.CARD_IN_DECK.length > 0){
      player1_board.CARD_IN_HAND.push(player1_board.CARD_IN_DECK.pop());
    }
  }
  if(player1_board.CARD_IN_DECK.length == 0){
    document.getElementById('P1_DECK').style.display = "none";
  }
  load_card();
}

function load_deck(){
    if(player1_board.CARD_IN_DECK.length > 0){
        document.getElementById('P1_DECK').src="images/SLEEVE.png";
        document.getElementById('P1_DECK').style.display = "block";
    }else{
        document.getElementById('P1_DECK').style.display = "none";
    }
}

function load_card(){
  const hand = document.querySelector('div[zone="'+'HAND'+'"]');
  const spirit_zone = document.querySelector('div[zone="'+'SPIRIT'+'"]');
  const nexus_zone = document.querySelector('div[zone="'+'NEXUS'+'"]');
  const burst_zone = document.querySelector('div[zone="'+'BURST'+'"]');
  const mirage_zone = document.querySelector('div[zone="'+'MIRAGE'+'"]');
    if(burst_zone.firstElementChild && player1_board.CARD_IN_BURST.length == 1) {
        burst_zone.firstElementChild.remove();
        burst_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" src="images/SLEEVE.png">');
    }else if(!burst_zone.firstElementChild && player1_board.CARD_IN_BURST.length == 1){
        burst_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" src="images/SLEEVE.png">');
    }else if(burst_zone.firstElementChild && player1_board.CARD_IN_BURST.length == 0){
        burst_zone.firstElementChild.remove();
    }

    if(mirage_zone.firstElementChild && player1_board.CARD_IN_MIRAGE.length == 1) {
        mirage_zone.firstElementChild.remove();
        mirage_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" src="images/'+player1_board.CARD_IN_MIRAGE[0]['card_image']+'.webp">');
    }else if(!mirage_zone.firstElementChild && player1_board.CARD_IN_MIRAGE.length == 1){
        mirage_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" src="images/'+player1_board.CARD_IN_MIRAGE[0]['card_image']+'.webp">');
    }else if(mirage_zone.firstElementChild && player1_board.CARD_IN_MIRAGE.length == 0){
        mirage_zone.firstElementChild.remove();
    }
    
  while (hand.firstElementChild) {hand.firstElementChild.remove();}
  while (spirit_zone.firstElementChild) {spirit_zone.firstElementChild.remove();}
  while (nexus_zone.firstElementChild) {nexus_zone.firstElementChild.remove();}
  player1_board.CARD_IN_HAND.forEach(function(v,i,a){
      hand.insertAdjacentHTML('beforeend','<img class="CARD_CSS" onclick="open_dialog(\'CARD\',\''+v['cid_id']+'\');" src="images/'+v['card_image']+'.webp">');
  })

  player1_board.CARD_IN_BOARD.forEach(function(v,i,a){
      if(v['card_type'] == 'spirit'){
          spirit_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" src="images/'+v['card_image']+'.webp">');
      }else if(v['card_type'] == 'nexus' || v['card_type'] == 'magic'){
          nexus_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" src="images/'+v['card_image']+'.webp">');
      }
  })
  if(player1_board.CARD_IN_GY.length > 0){
    document.getElementById('P1_GY').src = 'images/'+player1_board.CARD_IN_GY[player1_board.CARD_IN_GY.length-1]['card_image'] + '.webp';
  }
  

}

function load_core(){
    const life_zone    = document.querySelector('div[zone="'+'LIFE'+'"]');
    const reserve_zone = document.querySelector('div[zone="'+'RESERVE'+'"]');
    const counter_zone = document.querySelector('div[zone="'+'COUNTER'+'"] .COUNTER_NUMBER');
    while (life_zone.firstElementChild) {life_zone.firstElementChild.remove();}
    while (reserve_zone.firstElementChild) {reserve_zone.firstElementChild.remove();}
    if(player1_core.core_life <= 6){
        for(let i = 1; i<=player1_core.core_life;i++){
            life_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
        }
      }else{
            life_zone.classList.add("many_core");
            life_zone.classList.remove("slots");
            life_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
            life_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+player1_core.core_life+'</div>');
        }
    if(player1_core.core_reserve <= 6){ 
        for(let i = 1; i<=player1_core.core_reserve;i++){
            reserve_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
        }
      }else{      
            reserve_zone.classList.add("many_core");
            reserve_zone.classList.remove("slots");
            reserve_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
            reserve_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+ player1_core.core_reserve+'</div>');
        }
    counter_zone.innerHTML = player1_core.counter;
}

function open_dialog(p_type,p_cid_id){
  const dialog = document.getElementById("Dialog");
  document.getElementById("Dialog_title").innerText = "";
  document.getElementById("Dialog_detail").innerText = "";
  let p_card = test_deck.find(card => card.cid_id == p_cid_id);
  if(p_type == 'COIN'){
      document.getElementById("Dialog_title").innerText = "ทอยมาสิ หัว/ก้อย ?";
      const coin = document.createElement("div");   coin.id = "coin"; 
      const sideA = document.createElement("div");  sideA.className = "side-a";
      const sideB = document.createElement("div");  sideB.className = "side-b";
      coin.appendChild(sideA);  coin.appendChild(sideB);

      const button_container = document.createElement("div"); button_container.classList.add("button-container");
      const head = document.createElement("button"); head.onclick = function(){ flip_coin('HEAD'); }; head.innerText = "HEAD";
      const tail = document.createElement("button"); tail.onclick = function(){ flip_coin('TAIL'); }; tail.innerText = "TAIL";
      button_container.appendChild(head); button_container.appendChild(tail);

      document.getElementById("Dialog_detail").appendChild(coin);
      document.getElementById("Dialog_detail").appendChild(button_container);
      dialog.showModal();
      return;
  }else if(p_type == 'CARD' && p_card){
      document.getElementById("Dialog_title").innerText = p_card['card_name']; //+'\n' +
      let reduct_html = '';
      let v_btn = '',v_eff = '';
      let v_skills = JSON.parse(p_card['card_skills']) , v_levels = JSON.parse(p_card['card_levels']);
      console.log(v_skills);
      p_card['card_cost_reduct'].split(',').forEach(function(v,i,a){
          if(v == 'red') reduct_html += '<img src="images/Reduct_Red.png">';
          else if(v == 'blue') reduct_html += '<img src="images/Reduct_Blue.png">';
          else if(v == 'green') reduct_html += '<img src="images/Reduct_Green.png">';
          else if(v == 'god') reduct_html += '<img src="images/Reduct_God.png">';
          else if(v == 'colorless') reduct_html += '<img src="images/Reduct_Colorless.png">';
      });
      if (p_card['card_type'] == 'magic'){
        v_btn += '<button class="action_btn" onclick="use_card(\''+p_card['cid_id']+'\');">Use Magic</button>'+'\n';
      }else if (p_card['card_type'] == 'spirit'){
        v_btn += '<button class="action_btn" onclick="use_card(\''+p_card['cid_id']+'\');">Summon</button>'+'\n';
      }else if (p_card['card_type'] == 'nexus'){
        v_btn += '<button class="action_btn" onclick="use_card(\''+p_card['cid_id']+'\');">Deploy</button>'+'\n';
      }
      
      if (p_card['is_burst'] == 'Y'){
        v_btn += '<button class="action_btn" onclick="set_burst(\''+p_card['cid_id']+'\');">Set Burst</button>'+'\n';
      }
      if (p_card['is_mirage'] == 'Y'){
        v_btn += '<button class="action_btn" onclick="set_mirage(\''+p_card['cid_id']+'\');">Set Mirage</button>'+'\n';
      }
      if(v_skills){
        v_skills.forEach(function (v,i,a){
          v_eff += '<div class="CARD_EFFECT_LIST" onclick="use_skill(\''+v['CARD_SKILL'].replaceAll("'",'`')+'\' , \''+'1'+'\')">'+v['CARD_SKILL_DESC']+'</div>'+'\n' ;
        });
      }
      
      let detail = 
        '<div class="CARD_INFO">'+'\n' +
        '<img class="CARD_CSS_INFO" src="'+get_img(p_card['card_image'])+'">'+'\n' +
        '<div>'+'\n' +
        '<div class="CARD_TEXT">'+'\n' +
        '<div class="Label_info">Card Type : <div class="detail_info">'+p_card['card_type'] +'</div></div>'+'\n' +
        '<div class="Label_info">Color : <div class="detail_info">'+p_card['card_color'] +'</div></div>'+'\n' +
        '<div class="Label_info">Cost : <div class="detail_info">'+p_card['card_cost']+'</div></div>'+'\n' +
        '<div class="Label_info">Reductions : <div class="detail_info">'+reduct_html+'</div></div>'+'\n' +
        '<div class="Label_info">Families : <div class="detail_info">'+p_card['card_families']+'</div></div>'+'\n' +
        '</div>'+'\n' +
        '<div class="CARD_EFFECT">'+'\n' +
        '<div class="Label_info"> Effect : </div>'+'\n' +
        '<div class="detail_info">'+'\n' +
        v_eff +
        '</div>'+'\n' +
        '<div class="button-container" style="justify-content: center; margin-top: 10px;">'+'\n' +
        v_btn +
        '</div></div></div>';

      document.getElementById("Dialog_detail").insertAdjacentHTML('beforeend',detail);
      dialog.showModal();
      return;
  }
}

async function use_card(p_cid_id){
    const success = await get_card_to(
        player1_board.CARD_IN_HAND,
        player1_board.CARD_IN_BOARD,
        p_cid_id
    );
    if (success) {
        load_card();
        close_dialog();
    }
}

function set_mirage(p_cid_id){
    const success = get_card_to(
        player1_board.CARD_IN_HAND,
        player1_board.CARD_IN_MIRAGE,
        p_cid_id
    );  
    if (success) {
        load_card();
        close_dialog();
    }
}

function set_burst(p_cid_id){
    const success = get_card_to(
        player1_board.CARD_IN_HAND,
        player1_board.CARD_IN_BURST,
        p_cid_id
    );
    if (success) {
        load_card();
        close_dialog();
    }
}

function set_GY(p_get_from,p_cid_id) {
    const success = get_card_to(
        p_get_from,
        player1_board.CARD_IN_GY,
        p_cid_id
    );
    if (success) {
        load_card();
        close_dialog();
    }
    // load_card();
}

function use_skill(p_raw_code){
    // p_card = test_deck.find(card => card.cid_id == p_card_id);
    // alert("ใช้สกิลของ : " + p_card['card_name'] + ' สกิลที่ : ' + p_skill_no);
    let fn = new Function(p_raw_code);
    fn();
    close_dialog();
}

function close_dialog(){
  const dialog = document.getElementById("Dialog");
  dialog.close();
  document.getElementById("Dialog_title").innerText = "";
  document.getElementById("Dialog_detail").innerText = "";
}

function flip_coin(p_side) {
  var flipResult = Math.random();
  var coin = document.getElementById('coin');
  coin.classList.remove('heads');
  coin.classList.remove('tails');
  document.getElementById("Dialog_detail").removeChild(document.getElementById("Dialog_detail").lastChild);
    setTimeout(function(){
      if(flipResult <= 0.5){
        coin.classList.add('heads');
        coin_result = 'HEAD';
      }
      else{
        coin.classList.add('tails');
        coin_result = 'TAIL';
      }
    }, 100);
    setTimeout(function(){
      let result = '';
      if(p_side){
          if(p_side == coin_result) result = "คุณทายถูก";
          else result = "คุณทายผิด";
      }
      // document.getElementById("Dialog_detail").appendChild(document.createElement("p")).innerText = "ผลการทอยเหรียญ = " + coin_result + " (" + result + ")";
      const button_container = document.createElement("div"); button_container.classList.add("button-container");
      const First = document.createElement("button"); First.onclick = function(){ sel_turn('FIRST'); }; First.innerText = "First";
      const Second = document.createElement("button"); Second.onclick = function(){ sel_turn('LAST'); }; Second.innerText = "Second";
      button_container.appendChild(First); button_container.appendChild(Second);
      document.getElementById("Dialog_title").innerText = "เลือกเล่นก่อนหรือหลัง ?";
      document.getElementById("Dialog_detail").appendChild(button_container);
    }, 3100);
}
function sel_turn(p_side) {
    start_game();
    close_dialog();
}

function get_img(p_card_image){
    return 'images/'+p_card_image+'.webp';
}

async function get_card_to(p_list_card_from, p_list_card_to, p_cid_id){
  return new Promise((resolve) => {
    const index = p_list_card_from.findIndex(card => card.cid_id == p_cid_id);
    if (index > -1) { 
      p_list_card_to.push(p_list_card_from[index]);
      p_list_card_from.splice(index, 1); 
    }
    resolve(true);
  });
}

