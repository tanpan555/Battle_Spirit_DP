let test_deck = [{"cid_id":1,"card_id":"1","card_name":"The SunConcluserDragon Apollonia-Vern","card_cost":8,"card_cost_reduct":"red,red,red,god","card_type":"spirit","card_families":"Devotee, Concluser, Astral Dragon","card_image":"SD68-X01","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":10000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":3,\"CARD_POWER\":13000},{\"CARD_LEVEL\":3,\"CARD_LEVEL_COST\":5,\"CARD_POWER\":16000}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"console.log('Manifest');\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003EManifest: \\\"Contractor Apollon\\\" & C7 or more (Your Turn)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EBy sending your  to the Trash, pay one cost from the target to summon this card from the Hand.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":\"manifest\",\"CARD_SUMMON_COND\":\"[{'have_nexus_name : 'Contractor Apollon' },{ 'have_counter_more_equal' : '7'}]\",\"IS_FLASH\":\"Y\"},{\"CARD_LEVEL\":\"1,2,3\",\"CARD_SKILL\":\"console.log('Attack');\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003EUnleash: 2\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2][LV3] (When Attacks)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EDestroy an opposing Spirit/Ultimate with the highest BP, and for each symbol on the destroyed target, send an opposing Life to the Trash. By sending two cores from your Red Grandwalker Nexuses to this Spirit, this destruction effect can't be prevented by opposing effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2,3\",\"CARD_SKILL\":\"console.log('FLASH ATTACK');\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2][LV3] Flash - (When Attacks)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EOnce per turn, you can negate an opposing active White Magic/Accel effect, other than on-field effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"Y\"}]"},{"cid_id":2,"card_id":"1","card_name":"The SunConcluserDragon Apollonia-Vern","card_cost":8,"card_cost_reduct":"red,red,red,god","card_type":"spirit","card_families":"Devotee, Concluser, Astral Dragon","card_image":"SD68-X01","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":10000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":3,\"CARD_POWER\":13000},{\"CARD_LEVEL\":3,\"CARD_LEVEL_COST\":5,\"CARD_POWER\":16000}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"console.log('Manifest');\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003EManifest: \\\"Contractor Apollon\\\" & C7 or more (Your Turn)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EBy sending your  to the Trash, pay one cost from the target to summon this card from the Hand.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":\"manifest\",\"CARD_SUMMON_COND\":\"[{'have_nexus_name : 'Contractor Apollon' },{ 'have_counter_more_equal' : '7'}]\",\"IS_FLASH\":\"Y\"},{\"CARD_LEVEL\":\"1,2,3\",\"CARD_SKILL\":\"console.log('Attack');\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003EUnleash: 2\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2][LV3] (When Attacks)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EDestroy an opposing Spirit/Ultimate with the highest BP, and for each symbol on the destroyed target, send an opposing Life to the Trash. By sending two cores from your Red Grandwalker Nexuses to this Spirit, this destruction effect can't be prevented by opposing effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2,3\",\"CARD_SKILL\":\"console.log('FLASH ATTACK');\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2][LV3] Flash - (When Attacks)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EOnce per turn, you can negate an opposing active White Magic/Accel effect, other than on-field effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"Y\"}]"},{"cid_id":3,"card_id":"2","card_name":"The FlameWheelContractor Apollon","card_cost":2,"card_cost_reduct":"red","card_type":"nexus","card_families":"Grandwalker, Olym","card_image":"SD68-CX01","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":0,\"CARD_POWER\":null},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":6,\"CARD_POWER\":null}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003ENeo-Core Charge\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E(Astral Dragon/Devotee/Concluser & Cost 3 or more)\u003C/div\u003E\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":\"neo-core_charge\",\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003ERevive\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003EMain - (Once per Turn: Same Name) You can deploy this card from Soul State.\u003C/div\u003E\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003EContract Skill: 2\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2] Flash -\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003E(Once per turn, send two cores from this Nexus to the Void) Your counters +2. Then, if it's the Attack Step, ignoring \\\"BP+\\\" and \\\"give +BP\\\" effects, destroy an opposing 7000 BP or less Spirit/Ultimate.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"Y\"},{\"CARD_LEVEL\":\"6\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003EContract Field\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2] (Your Attack Step)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003E(Can't Stack) When your \\\"Astral Dragon\\\" family Spirit attacks, you can reveal a card from your decktop. If it's a \\\"Devotee\\\"/\\\"Concluser\\\" family card, send an opposing Life to the Reserve. Add the revealed card to the Hand.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":4,"card_id":"2","card_name":"The FlameWheelContractor Apollon","card_cost":2,"card_cost_reduct":"red","card_type":"nexus","card_families":"Grandwalker, Olym","card_image":"SD68-CX01","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":0,\"CARD_POWER\":null},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":6,\"CARD_POWER\":null}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003ENeo-Core Charge\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E(Astral Dragon/Devotee/Concluser & Cost 3 or more)\u003C/div\u003E\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":\"neo-core_charge\",\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003ERevive\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003EMain - (Once per Turn: Same Name) You can deploy this card from Soul State.\u003C/div\u003E\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003EContract Skill: 2\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2] Flash -\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003E(Once per turn, send two cores from this Nexus to the Void) Your counters +2. Then, if it's the Attack Step, ignoring \\\"BP+\\\" and \\\"give +BP\\\" effects, destroy an opposing 7000 BP or less Spirit/Ultimate.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"Y\"},{\"CARD_LEVEL\":\"6\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"card_ability\\\"\u003EContract Field\u003C/div\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2] (Your Attack Step)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003E(Can't Stack) When your \\\"Astral Dragon\\\" family Spirit attacks, you can reveal a card from your decktop. If it's a \\\"Devotee\\\"/\\\"Concluser\\\" family card, send an opposing Life to the Reserve. Add the revealed card to the Hand.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":5,"card_id":"3","card_name":"Folk-StarDragon","card_cost":4,"card_cost_reduct":"red,red,god","card_type":"spirit","card_families":"Devotee, Astral Dragon","card_image":"SD68-003","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":3000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":2,\"CARD_POWER\":6000}]","card_skills":"[{\"CARD_LEVEL\":\"1,2\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2] (When Summoned)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EReturn a non-Cost 4 \\\"Astral Dragon\\\"/\\\"Olym\\\" family card from your Trash to the Hand.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2] (Your Attack Step)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EWhen your Hand increases via your \\\"Astral Dragon\\\"/\\\"Olym\\\" family effect, you can destroy an opposing 5000 BP or less Spirit/Ultimate. For each core on all your \\\"Contractor Apollon\\\" combined, increase the limit of this \\\"BP Destruction effect\\\" by +2000.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":6,"card_id":"3","card_name":"Folk-StarDragon","card_cost":4,"card_cost_reduct":"red,red,god","card_type":"spirit","card_families":"Devotee, Astral Dragon","card_image":"SD68-003","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":3000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":2,\"CARD_POWER\":6000}]","card_skills":"[{\"CARD_LEVEL\":\"1,2\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2] (When Summoned)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EReturn a non-Cost 4 \\\"Astral Dragon\\\"/\\\"Olym\\\" family card from your Trash to the Hand.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2] (Your Attack Step)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EWhen your Hand increases via your \\\"Astral Dragon\\\"/\\\"Olym\\\" family effect, you can destroy an opposing 5000 BP or less Spirit/Ultimate. For each core on all your \\\"Contractor Apollon\\\" combined, increase the limit of this \\\"BP Destruction effect\\\" by +2000.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":7,"card_id":"4","card_name":"Star Dragon Draw","card_cost":3,"card_cost_reduct":"red,red","card_type":"magic","card_families":"Astral Dragon","card_image":"SD68-005","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":0,\"CARD_LEVEL_COST\":null,\"CARD_POWER\":null}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"draw_deck(2)\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003EMain\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EDraw a card. Then, you can reveal four cards from your decktop. Among them, add either an \\\"Apollon\\\" Grandwalker Nexus card, or a \\\"Concluser\\\" family Spirit card to the Hand. Return any remaining cards to the deckbottom.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":8,"card_id":"4","card_name":"Star Dragon Draw","card_cost":3,"card_cost_reduct":"red,red","card_type":"magic","card_families":"Astral Dragon","card_image":"SD68-005","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":0,\"CARD_LEVEL_COST\":null,\"CARD_POWER\":null}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"draw_deck(2)\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003EMain\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EDraw a card. Then, you can reveal four cards from your decktop. Among them, add either an \\\"Apollon\\\" Grandwalker Nexus card, or a \\\"Concluser\\\" family Spirit card to the Hand. Return any remaining cards to the deckbottom.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":9,"card_id":"5","card_name":"WhiteHole Dragon","card_cost":3,"card_cost_reduct":"red,red","card_type":"spirit","card_families":"Astral Dragon","card_image":"SD68-RV002","card_color":"red","card_core":0,"is_mirage":"Y","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":3000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":2,\"CARD_POWER\":5000}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"set_mirage('this_cid_id')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003EMirage: Cost 3 (img_red img_red)\u003C/div\u003E\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":\"mirage\",\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"1,2\",\"CARD_SKILL\":\"console.log('CONT')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2]\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EYour Red Spirits/Ultimates can't be returned to the Hand/Deck by opposing effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2\",\"CARD_SKILL\":\"console.log('CONT')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2] (Your Attack Step)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EWhile your \\\"Astral Dragon\\\" family Spirit is attacking, the opponent can't end the Attack Step via effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":10,"card_id":"5","card_name":"WhiteHole Dragon","card_cost":3,"card_cost_reduct":"red,red","card_type":"spirit","card_families":"Astral Dragon","card_image":"SD68-RV002","card_color":"red","card_core":0,"is_mirage":"Y","is_burst":"N","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":3000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":2,\"CARD_POWER\":5000}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"set_mirage('this_cid_id')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003EMirage: Cost 3 (img_red img_red)\u003C/div\u003E\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":\"mirage\",\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"1,2\",\"CARD_SKILL\":\"console.log('CONT')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2]\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EYour Red Spirits/Ultimates can't be returned to the Hand/Deck by opposing effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2\",\"CARD_SKILL\":\"console.log('CONT')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2] (Your Attack Step)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EWhile your \\\"Astral Dragon\\\" family Spirit is attacking, the opponent can't end the Attack Step via effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":11,"card_id":"6","card_name":"The ArdentStarDragon Zon-Balphard","card_cost":5,"card_cost_reduct":"red,red,god","card_type":"spirit","card_families":"Devotee, Astral Dragon","card_image":"SD68-004","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"Y","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":4000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":3,\"CARD_POWER\":7000},{\"CARD_LEVEL\":3,\"CARD_LEVEL_COST\":4,\"CARD_POWER\":9000}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"console.log('skill')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"EFF_B\\\"\u003EWhen this card is revealed by the Contract Field of your “Contractor Apollon”, you can summon it by paying one cost.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"console.log('BURST')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[ Burst: After your Spirit/Nexus is destroyed by the Opponent ]\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003ESummon this card without paying the cost.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":\"BURST\",\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"1,2,3\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2][LV3] (When Summoned)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EYou can destroy an opposing 10000 BP or less Spirit/Ultimate. When summoned via an effect, this “BP Destruction effect” ignores “BP+” and “give + BP” effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2,3\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2][LV3] (When Attacks)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EDestroy an opposing Nexus.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"},{"cid_id":12,"card_id":"6","card_name":"The ArdentStarDragon Zon-Balphard","card_cost":5,"card_cost_reduct":"red,red,god","card_type":"spirit","card_families":"Devotee, Astral Dragon","card_image":"SD68-004","card_color":"red","card_core":0,"is_mirage":"N","is_burst":"Y","card_levels":"[{\"CARD_LEVEL\":1,\"CARD_LEVEL_COST\":1,\"CARD_POWER\":4000},{\"CARD_LEVEL\":2,\"CARD_LEVEL_COST\":3,\"CARD_POWER\":7000},{\"CARD_LEVEL\":3,\"CARD_LEVEL_COST\":4,\"CARD_POWER\":9000}]","card_skills":"[{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"console.log('skill')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"EFF_B\\\"\u003EWhen this card is revealed by the Contract Field of your “Contractor Apollon”, you can summon it by paying one cost.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"0\",\"CARD_SKILL\":\"console.log('BURST')\",\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[ Burst: After your Spirit/Nexus is destroyed by the Opponent ]\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003ESummon this card without paying the cost.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":\"BURST\",\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"1,2,3\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV1][LV2][LV3] (When Summoned)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EYou can destroy an opposing 10000 BP or less Spirit/Ultimate. When summoned via an effect, this “BP Destruction effect” ignores “BP+” and “give + BP” effects.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"},{\"CARD_LEVEL\":\"2,3\",\"CARD_SKILL\":null,\"CARD_SKILL_DESC\":\"\u003Cdiv class=\\\"row\\\"\u003E\u003Cdiv class=\\\"EFF_H\\\"\u003E[LV2][LV3] (When Attacks)\u003C/div\u003E\u003C/div\u003E\u003Cdiv class=\\\"EFF_B\\\"\u003EDestroy an opposing Nexus.\u003C/div\u003E\",\"CARD_SUMMON_TYPE\":null,\"CARD_SUMMON_COND\":null,\"IS_FLASH\":\"N\"}]"}];


function createBoardState() {
    return {
      CARD_IN_HAND   : [],
      CARD_IN_BURST  : [],
      CARD_IN_MIRAGE : [],
      CARD_IN_BOARD  : [],
      CARD_IN_DECK   : [],
      CARD_IN_GY     : [],
      CARD_IN_BANISH : [],
  };
}

function createCoreState() {
    return {
        core_life : 0,
        soul_core_life : 0,
        core_reserve : 0,
        soul_core_reserve : 0,
        core_trash : 0,
        soul_core_trash : 0,
        counter : 0,
        board : {},
    };
}
let player1_board = createBoardState();
let player1_core = createCoreState();
let player1_core_paid = createCoreState();

let player2_board = createBoardState();
let player2_core = createCoreState();
let player2_core_paid = createCoreState();7

let coin_result ;
let player_zone , player_core , player_board;

function add_core(p_zone,p_amt,player_side){
    player_zone = (player_side == 1? '#playmat1' : '#playmat2');
    player_core = (player_side == 1? player1_core : player2_core);
    const selected_zone = document.querySelector(player_zone + ' div[zone="'+p_zone+'"]');
    switch(p_zone){
        case 'LIFE':    player_core.core_life    += p_amt; break;
        case 'RESERVE': player_core.core_reserve += p_amt; break;
        case 'COUNTER': player_core.counter      += p_amt; break;
    }
    load_core(player_side);
}

function remove_core(p_zone,p_amt,player_side){
  player_zone = (player_side == 1? '#playmat1' : '#playmat2');
  player_core = (player_side == 1? player1_core : player2_core);
  let selected_zone = document.querySelector(player_zone + ' div[zone="'+p_zone+'"]');
   switch(p_zone){
        case 'LIFE':    player_core.core_life    -= p_amt; break;
        case 'RESERVE': player_core.core_reserve -= p_amt; break;
        case 'COUNTER': player_core.counter      -= p_amt; break;
    }
    load_core(player_side);
}

function set_default_core(){
    player1_core.core_life = 5;
    player1_core.core_reserve = 3;
    player1_core.soul_core_reserve = 1;
    player1_core.counter = 0;

    player2_core.core_life = 5;
    player2_core.core_reserve = 3;
    player2_core.soul_core_reserve = 1;
    player2_core.counter = 0;
    load_core();
}

function add_card(p_zone,p_card_id,player_side){
  player_zone = (player_side == 1? '#playmat1' : '#playmat2');
    const selected_zone = document.querySelector(player_zone + ' div[zone="'+p_zone+'"]');
    selected_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" src="images/SLEEVE.png">');
}

function remove_card(p_zone,p_card_id,player_side){
  player_zone = (player_side == 1? '#playmat1' : '#playmat2');
   let zone = document.querySelector(player_zone + ' div[zone="'+p_zone+'"]');
    if(zone.lastElementChild) zone.lastElementChild.remove();
}

function add_counter(p_value,player_side){
  player_zone = (player_side == 1? '#playmat1' : '#playmat2');
  player_core = (player_side == 1? player1_core : player2_core);
  player_core.counter +=p_value;
    let zone = document.querySelector(player_zone + ' [zone="COUNTER"] .COUNTER_NUMBER');   

    if(zone) zone.innerHTML = player_core.counter;
}

function shuffle(sourceArray) {
    for (let i = 0; i < sourceArray.length - 1; i++) {
        let j = i + Math.floor(Math.random() * (sourceArray.length - i));

        let temp = sourceArray[j];
        sourceArray[j] = sourceArray[i];
        sourceArray[i] = temp;
    }
    return sourceArray;
}

function cloneDeck(deck) {
  return deck.map(card => JSON.parse(JSON.stringify(card)));
}

async function get_deck(p_deck_id) {
    if (p_deck_id == 0) {
    let deck = shuffle(cloneDeck(test_deck));
    return deck;
  }else{
      
      const apiUrl = 'https://oracleapex.com/ords/wksp_rmutttransfer/bst/DECK?DECK_ID=' + p_deck_id;
      // console.log("apiUrl:", apiUrl);
      try {
        const response = await fetch(apiUrl, {
          method: "GET",
          headers: {"Content-Type": "application/json"}
        });
        const data = await response.json();
        player1_board.CARD_IN_DECK = shuffle(data.items);
        return shuffle(data.items);
      } catch (error) {
        alert("Error: โหลด Deck ไม่ได้จ้า");
        throw error;
      }
    }
    
}


async function start_game() {
    player1_board.CARD_IN_DECK = await get_deck(document.getElementById('deck_id').value);
    player2_board.CARD_IN_DECK = await get_deck(document.getElementById('deck_id').value);
    load_deck(1);
    load_deck(2);
    set_default_core();
    load_core(1);
    load_core(2);
}

function draw_deck(p_amt, player_side, delay = 200) {
  p_amt = p_amt || 1;
  let board, deckElem;

  if (player_side === 1) {
    board = player1_board;
    deckElem = document.getElementById('P1_DECK');
  } else if (player_side === 2) {
    board = player2_board;
    deckElem = document.getElementById('P2_DECK');
  } else {
    console.warn("Invalid player_side:", player_side);
    return;
  }

  // Async loop with delay for smooth drawing
  let i = 0;
  function drawNext() {
    if (i >= p_amt) return;

    if (board.CARD_IN_DECK.length > 0) {
      let get_card = board.CARD_IN_DECK.pop();
      board.CARD_IN_HAND.push(get_card);
      load_card(player_side); // update UI after each card
    }

    if (board.CARD_IN_DECK.length === 0) {
      deckElem.style.display = "none";
      return;
    }

    i++;
    setTimeout(drawNext, delay); // wait before drawing next card
  }
  drawNext();
}


function load_deck(){
    if(player1_board.CARD_IN_DECK.length > 0){
        document.getElementById('P1_DECK').src="images/SLEEVE.png";
        document.getElementById('P1_DECK').style.display = "block";
    }else{
        document.getElementById('P1_DECK').style.display = "none";
    }
    if(player2_board.CARD_IN_DECK.length > 0){
        document.getElementById('P2_DECK').src="images/SLEEVE.png";
        document.getElementById('P2_DECK').style.display = "block";
    }else{
        document.getElementById('P2_DECK').style.display = "none";
    }
}

function load_card(player_side){
  player_zone = (player_side == 1? '#playmat1' : '#playmat2');
  player_board = (player_side == 1? player1_board : player2_board);
  const hand        = document.querySelector(player_zone + ' div[zone="'+'HAND'+'"]');
  const spirit_zone = document.querySelector(player_zone + ' div[zone="'+'SPIRIT'+'"]');
  const nexus_zone  = document.querySelector(player_zone + ' div[zone="'+'NEXUS'+'"]');
  const burst_zone  = document.querySelector(player_zone + ' div[zone="'+'BURST'+'"]');
  const mirage_zone = document.querySelector(player_zone + ' div[zone="'+'MIRAGE'+'"]');
  

    if(burst_zone.firstElementChild && player_board.CARD_IN_BURST.length == 1) {
        burst_zone.firstElementChild.remove();
        burst_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" onclick="open_dialog(\'CARD\',\'BURST\',\''+ player_board.CARD_IN_BURST[0]['cid_id']+'\', \''+player_side+'\')" src="images/SLEEVE.png">');
    }else if(!burst_zone.firstElementChild && player_board.CARD_IN_BURST.length == 1){
        burst_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" onclick="open_dialog(\'CARD\',\'BURST\',\''+ player_board.CARD_IN_BURST[0]['cid_id']+'\', \''+player_side+'\')" src="images/SLEEVE.png">');
    }else if(burst_zone.firstElementChild && player_board.CARD_IN_BURST.length == 0){
        burst_zone.firstElementChild.remove();
    }

    if(mirage_zone.firstElementChild && player_board.CARD_IN_MIRAGE.length == 1) {
        mirage_zone.firstElementChild.remove();
        mirage_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" onclick="open_dialog(\'CARD\',\'MIRAGE\',\''+ player_board.CARD_IN_MIRAGE[0]['cid_id']+'\', \''+player_side+'\')" src="images/'+player_board.CARD_IN_MIRAGE[0]['card_image']+'.webp">');
    }else if(!mirage_zone.firstElementChild && player_board.CARD_IN_MIRAGE.length == 1){
        mirage_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" onclick="open_dialog(\'CARD\',\'MIRAGE\',\''+ player_board.CARD_IN_MIRAGE[0]['cid_id']+'\', \''+player_side+'\')" src="images/'+player_board.CARD_IN_MIRAGE[0]['card_image']+'.webp">');
    }else if(mirage_zone.firstElementChild && player_board.CARD_IN_MIRAGE.length == 0){
        mirage_zone.firstElementChild.remove();
    }
    
  while (hand.firstElementChild) {hand.firstElementChild.remove();}
  while (spirit_zone.firstElementChild) {spirit_zone.firstElementChild.remove();}
  while (nexus_zone.firstElementChild) {nexus_zone.firstElementChild.remove();}
  player_board.CARD_IN_HAND.forEach(function(v,i,a){
      hand.insertAdjacentHTML('beforeend','<img class="CARD_CSS" onclick="open_dialog(\'CARD\',\'HAND\',\''+v['cid_id']+'\', \''+player_side+'\');" src="images/'+v['card_image']+'.webp">');
  })

  player_board.CARD_IN_BOARD.forEach(function(v,i,a){
      if(v['card_type'] == 'spirit'){
          spirit_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS" onclick="open_dialog(\'CARD\',\'BOARD\',\''+ v['cid_id']+'\', \''+player_side+'\')" src="images/'+v['card_image']+'.webp">');
      }else if(v['card_type'] == 'nexus' || v['card_type'] == 'magic'){
          nexus_zone.insertAdjacentHTML('beforeend','<img class="CARD_CSS"  onclick="open_dialog(\'CARD\',\'BOARD\',\''+ v['cid_id']+'\', \''+player_side+'\')" src="images/'+v['card_image']+'.webp">');
      }
  })
  if(player_board.CARD_IN_GY.length > 0){
    document.getElementById('P1_GY').src = 'images/'+player_board.CARD_IN_GY[player_board.CARD_IN_GY.length-1]['card_image'] + '.webp';
  }
  
}

function load_core(player_side){
  player_zone = (player_side == 1? '#playmat1' : '#playmat2');
  player_core = (player_side == 1? player1_core : player2_core);
    const life_zone    = document.querySelector(player_zone + ' div[zone="'+'LIFE'+'"]');
    const reserve_zone = document.querySelector(player_zone + ' div[zone="'+'RESERVE'+'"]');
    const counter_zone = document.querySelector(player_zone + ' div[zone="'+'COUNTER'+'"] .COUNTER_NUMBER');
    while (life_zone.firstElementChild) {life_zone.firstElementChild.remove();}
    while (reserve_zone.firstElementChild) {reserve_zone.firstElementChild.remove();}

    total_core_in_life    = player_core.core_life    + player_core.soul_core_life;
    total_core_in_reserve = player_core.core_reserve + player_core.soul_core_reserve;
    total_core_in_trash   = player_core.core_trash   + player_core.soul_core_trash;

    if(total_core_in_life <= 6){
        life_zone.classList.remove("many_core");
        life_zone.classList.add("slots");
        if(player_core.soul_core_life > 0){
            life_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Soul_Core.webp"></div>');
        }
        for(let i = 1; i<=player_core.core_life;i++){
            life_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
        }
      }else{
            life_zone.classList.add("many_core");
            life_zone.classList.remove("slots");
            if(player_core.soul_core_life > 0){
              life_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Soul_Core.webp"></div>');
              life_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+ player_core.soul_core_life+'</div>');            
            }
            life_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
            life_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+player_core.core_life+'</div>');

      }
    if(total_core_in_reserve <= 6){ 
        reserve_zone.classList.remove("many_core");
        reserve_zone.classList.add("slots");
        if(player_core.soul_core_reserve > 0){
              reserve_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Soul_Core.webp"></div>');
          }
        for(let i = 1; i<=player_core.core_reserve;i++){
            reserve_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
        }
      }else{      
            reserve_zone.classList.add("many_core");
            reserve_zone.classList.remove("slots");
            if(player_core.soul_core_reserve > 0){
              reserve_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Soul_Core.webp"></div>');
              reserve_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+ player_core.soul_core_reserve+'</div>');            
            }
            reserve_zone.insertAdjacentHTML('beforeend','<div class="slot"><img class="Blue_core" src="images/Blue_core.webp"></div>');
            reserve_zone.insertAdjacentHTML('beforeend','<div class="CORE_NUMBER"> ×'+ player_core.core_reserve+'</div>');
            
            
        }
    counter_zone.innerHTML = player_core.counter;
}

function open_dialog1(p_type, zone, p_cid_id, player_side) {
  return new Promise((resolve) => {
    const dialog        = document.getElementById("Dialog_list");
    const dialog_detail = document.getElementById("Dialog_list_detail");
    const list_group_row = document.createElement('div');
    let player_board = (player_side == 1 ? player1_board : player2_board);
    if (player_side == 1) {
      player1_core_paid = createCoreState();
    } else {
      player2_core_paid = createCoreState();
    }
    let player_core_paid = (player_side == 1 ? player1_core_paid : player2_core_paid);

    list_group_row.classList.add('list_group_row');
    while (dialog_detail.firstElementChild) {
      dialog_detail.firstElementChild.remove();
    }

    if (p_type == 'CORE') {
      if (zone.includes("LIFE")) {
        const life_list = document.createElement('div');
        life_list.classList.add("list_group");
        life_list.innerHTML += '<div class="title">Life</div>';
        life_list.innerHTML +=
          '<div class="group_container"><img class="Blue_core" src="images/Blue_core.webp"><div id="P1_CORE_PAID_LIFE" class="CORE_NUMBER"> ×' +
          player1_core_paid.core_life +
          '</div>' +
          '<div class="button-container" style="justify-content: center; margin-top: 20px;">' +
          '<button class="btn_core" onclick="paid_core(\'LIFE\',-1)">-</button>' +
          '<button class="btn_core" onclick="paid_core(\'LIFE\',1)">+</button>' +
          '</div>';
        list_group_row.appendChild(life_list);
      }
      if (zone.includes("RESERVE")) {
        const reserve_list = document.createElement('div');
        reserve_list.classList.add("list_group");
        reserve_list.innerHTML += '<div class="title">Reserve</div>';
        reserve_list.innerHTML +=
          '<div class="group_container"><img class="Blue_core" src="images/Blue_core.webp"><div id="P1_CORE_PAID_RESERVE" class="CORE_NUMBER"> ×' +
          player1_core_paid.core_reserve +
          '</div>' +
          '<div class="button-container" style="justify-content: center; margin-top: 20px;">' +
          '<button class="btn_core" onclick="paid_core(\'RESERVE\',-1)">-</button>' +
          '<button class="btn_core" onclick="paid_core(\'RESERVE\',1)">+</button>' +
          '</div>';
        list_group_row.appendChild(reserve_list);
      }
      if (zone.includes("FIELD") && player_board.CARD_IN_BOARD.length > 0) {
        const field_list = document.createElement('div');
        field_list.classList.add("list_group");
        field_list.innerHTML += '<div class="title">Field</div>';
        for (let i = 0; i < player_board.CARD_IN_BOARD.length; i++) {
          field_list.innerHTML +=
            '<div class="group_container"><img class="CARD_CSS" src="' +
            get_img(player_board.CARD_IN_BOARD[i]["card_image"]) +
            '"><div id="CORE_OF_' +
            player_board.CARD_IN_BOARD[i]["cid_id"] +
            '" class="CORE_NUMBER"> ×' +
            player_board.CARD_IN_BOARD[i]["card_core"] +
            "</div>" +
            '<div class="button-container" style="justify-content: center; margin-top: 20px;">' +
            '<button class="btn_core" onclick="paid_core(\'FIELD\',-1)">-</button>' +
            '<button class="btn_core" onclick="paid_core(\'FIELD\',1)">+</button>' +
            "</div></div>";
        }
        list_group_row.appendChild(field_list);
      }
    }

    dialog_detail.appendChild(list_group_row);

    // Add confirm button dynamically and resolve promise when clicked
    const confirmBtn = document.createElement("button");
    confirmBtn.classList.add("btn_dialog_cf");
    confirmBtn.innerText = "Confirm";
    confirmBtn.onclick = () => {
      let cost     = calculateRemainingCost(p_cid_id,player_side);
      let core_use = totalCoresPaid(player_board);
      console.log(cost,core_use);
      dialog.close();
      resolve(true);
    };

    const confirmContainer = document.createElement("div");
    confirmContainer.classList.add("button-container");
    confirmContainer.style.cssText = "justify-content: center; margin-top: 20px;";
    confirmContainer.appendChild(confirmBtn);

    dialog_detail.appendChild(confirmContainer);
    dialog.showModal();
  });
}
//////////////////////////////////////////////////////////////////////////////////
// 1️⃣ Get cost_reduct list for a specific card
function getCostReduct(cid,player_side) {
  player_board = (player_side == 1? player1_board : player2_board);
  let card = player_board.CARD_IN_HAND.find(c => c.cid_id === cid);
  if (!card) return [];
  return card.card_cost_reduct.split(",");
}

// 2️⃣ Get all symbols on the board
function getAllBoardSymbols(player_side) {
  player_board = (player_side == 1? player1_board : player2_board);
  return player_board.flatMap(card => card.card_symbol.split(","));
}

// 3️⃣ Calculate max reduction with prioritized exact matches
function calculateRemainingCost(cid,player_side) {
  player_board = (player_side == 1? player1_board : player2_board);
  let card = player_board.CARD_IN_HAND.find(c => c.cid_id === cid);
  if (!card) return null;

  let costReduct = getCostReduct(cid); // symbols required
  let boardSymbols = getAllBoardSymbols();

  let tempSymbols = [...boardSymbols];
  let reductionCount = 0;

  for (let costSym of costReduct) {
    // 1️⃣ Try to find exact match first
    let exactIndex = tempSymbols.findIndex(sym => !sym.includes("/") && sym === costSym);

    if (exactIndex !== -1) {
      reductionCount++;
      tempSymbols.splice(exactIndex, 1);
      continue;
    }

    // 2️⃣ Try to find a multi-color symbol that can match
    let multiIndex = tempSymbols.findIndex(sym => sym.includes("/") && sym.split("/").includes(costSym));
    if (multiIndex !== -1) {
      reductionCount++;
      tempSymbols.splice(multiIndex, 1);
    }
  }

  let remainingCost = Math.max(0, card.card_cost - reductionCount);
  // return {
  //   maxReduction: reductionCount,
  //   remainingCost: remainingCost
  // };
  return remainingCost;
}

function sumTopLevelCores(obj) {
  let sum = 0;
  for (let key in obj) {
    if (key !== 'board' && typeof obj[key] === 'number') {
      sum += obj[key];
    }
  }
  return sum;
}

// Sum core_use in board array
function sumBoardCoreUse(board) {
  
  return board ? board.reduce((acc, item) => acc + item.core_use, 0) : 0;
}

// Full total cores paid
function totalCoresPaid(player) {
  return sumTopLevelCores(player) + sumBoardCoreUse(player.board);
}

//////////////////////////////////////////////////////////////////////////////////

function paid_core(p_type,p_amt){
  if(p_type == 'LIFE'){
    if(player1_core_paid.core_life >= 0 && player1_core_paid.core_life <= player1_core.core_life){
      player1_core_paid.core_life += p_amt;
      document.getElementById('P1_CORE_PAID_LIFE').innerHTML = ' ×' + player1_core_paid.core_life;
    }
  }else if(p_type == 'RESERVE'){
    if(player1_core_paid.core_reserve >= 0 && player1_core_paid.core_reserve <= player1_core.core_reserve){
      player1_core_paid.core_reserve += p_amt;
      document.getElementById('P1_CORE_PAID_RESERVE').innerHTML = ' ×' + player1_core_paid.core_reserve;
    }
  }

}

function close_dialog(){
  const dialog = document.getElementById("Dialog");
  dialog.close();
  document.getElementById("Dialog_title").innerText = "";
  document.getElementById("Dialog_detail").innerText = "";
}

function close_dialog1(){
  const dialog = document.getElementById("Dialog_list");
  dialog.close();
  document.getElementById("Dialog_list_title").innerText = "";
  document.getElementById("Dialog_list_detail").innerText = "";
}

function open_dialog(p_type,p_location,p_cid_id,player_side){
  const dialog = document.getElementById("Dialog");
  document.getElementById("Dialog_title").innerText = "";
  document.getElementById("Dialog_detail").innerText = "";
  let p_card = test_deck.find(card => card.cid_id == p_cid_id);
  if(p_type == 'COIN'){
      document.getElementById("Dialog_title").innerText = "ทอยมาสิ หัว/ก้อย ?";
      const coin = document.createElement("div");   coin.id = "coin"; 
      const sideA = document.createElement("div");  sideA.className = "side-a";
      const sideB = document.createElement("div");  sideB.className = "side-b";
      coin.appendChild(sideA);  coin.appendChild(sideB);

      const button_container = document.createElement("div"); button_container.classList.add("button-container");
      const head = document.createElement("button"); head.onclick = function(){ flip_coin('HEAD'); }; head.innerText = "HEAD";
      const tail = document.createElement("button"); tail.onclick = function(){ flip_coin('TAIL'); }; tail.innerText = "TAIL";
      button_container.appendChild(head); button_container.appendChild(tail);

      document.getElementById("Dialog_detail").appendChild(coin);
      document.getElementById("Dialog_detail").appendChild(button_container);
      dialog.showModal();
      return;
  }else if(p_type == 'CARD' && p_card){
      document.getElementById("Dialog_title").innerText = p_card['card_name']; //+'\n' +
      let reduct_html = '';
      let v_btn = '',v_eff = '';
      let v_skills = JSON.parse(p_card['card_skills']) , v_levels = JSON.parse(p_card['card_levels']);
      p_card['card_cost_reduct'].split(',').forEach(function(v,i,a){
          if(v == 'red') reduct_html            += '<img src="images/Reduct_Red.png">';
          else if(v == 'blue') reduct_html      += '<img src="images/Reduct_Blue.png">';
          else if(v == 'green') reduct_html     += '<img src="images/Reduct_Green.png">';
          else if(v == 'god') reduct_html       += '<img src="images/Reduct_God.png">';
          else if(v == 'colorless') reduct_html += '<img src="images/Reduct_Colorless.png">';
      });
      if(p_location == 'HAND'){
        if (p_card['card_type'] == 'magic'){
          // v_btn += '<button class="action_btn" onclick="use_card(\''+p_card['cid_id']+'\', \''+player_side+'\');">Use Magic</button>'+'\n';
        }else if (p_card['card_type'] == 'spirit'){
          v_btn += '<button class="action_btn" onclick="use_card(\''+p_card['cid_id']+'\', \''+player_side+'\');">Summon</button>'+'\n';
        }else if (p_card['card_type'] == 'nexus'){
          v_btn += '<button class="action_btn" onclick="use_card(\''+p_card['cid_id']+'\', \''+player_side+'\');">Deploy</button>'+'\n';
        }
        if (p_card['is_burst'] == 'Y'){
          v_btn += '<button class="action_btn" onclick="set_burst(\''+p_card['cid_id']+'\', \''+player_side+'\');">Set Burst</button>'+'\n';
        }
        if (p_card['is_mirage'] == 'Y'){
          v_btn += '<button class="action_btn" onclick="set_mirage(\''+p_card['cid_id']+'\', \''+player_side+'\');">Set Mirage</button>'+'\n';
        }
      }
      if(p_location == 'BURST'){
        v_btn += '<button class="action_btn" onclick="use_burst(\''+p_card['cid_id']+'\', \''+player_side+'\');">activate_burst</button>'+'\n';
      }
      if(v_skills.length > 0){
        v_skills.forEach(function (v,i,a){
          v_eff += '<div class="CARD_EFFECT_LIST '+ (p_location == 'HAND' ? 'IN_HAND' : '' ) + '" '+
                      'onclick="use_skill(\''+ convert_skill(v['CARD_SKILL'],p_card) + '\' , \''+p_card['cid_id']+'\')">'+v['CARD_SKILL_DESC']
                                                                                                                  .replaceAll('img_red',    '<img class="core_img" src="images/Reduct_Red.png">')
                                                                                                                  .replaceAll('img_blue',   '<img class="core_img" src="images/Reduct_Blue.png">')
                                                                                                                  .replaceAll('img_green',  '<img class="core_img" src="images/Reduct_Green.png">')
                                                                                                                  .replaceAll('img_purple', '<img class="core_img" src="images/Reduct_Purple.png">')
                                                                                                                  .replaceAll('img_yellow', '<img class="core_img" src="images/Reduct_Yellow.png">')
                                                                                                                  .replaceAll('img_god',    '<img class="core_img" src="images/Reduct_God.png">')
                    
                      +'</div>'+'\n' ;
        });
      }
      let detail = 
        '<div class="CARD_INFO">'+'\n' +
        '<img class="CARD_CSS_INFO" src="'+get_img(p_card['card_image'])+'">'+'\n' +
        '<div>'+'\n' +
        '<div class="CARD_TEXT">'+'\n' +
        '<div class="Label_info">Card Type : <div class="detail_info">'+p_card['card_type'] +'</div></div>'+'\n' +
        '<div class="Label_info">Color : <div class="detail_info">'+p_card['card_color'] +'</div></div>'+'\n' +
        '<div class="Label_info">Cost : <div class="detail_info">'+p_card['card_cost']+'</div></div>'+'\n' +
        '<div class="Label_info">Reductions : <div class="detail_info">'+reduct_html+'</div></div>'+'\n' +
        '<div class="Label_info">Families : <div class="detail_info">'+p_card['card_families']+'</div></div>'+'\n' +
        '</div>'+'\n' +
        '<div class="CARD_EFFECT">'+'\n' +
        '<div class="Label_info"> Effect : </div>'+'\n' +
        '<div class="detail_info">'+'\n' +
        v_eff +
        '</div>'+'\n' +
        '<div class="button-container" style="justify-content: center; margin-top: 10px;">'+'\n' +
        v_btn +
        '</div></div></div>';

      document.getElementById("Dialog_detail").insertAdjacentHTML('beforeend',detail);
      dialog.showModal();
      return;
  }
}

function convert_skill(p_skill,p_card){
  if(p_skill){
    return p_skill
          .replaceAll("'",'`')
          .replaceAll('this_cid_id',p_card['cid_id']);
  }else{
    return p_skill;
  }
  
          
}

function use_burst(p_cid_id){
}

async function use_card(p_cid_id,player_side){
    const confirmed = await open_dialog1("CORE", ["RESERVE", "FIELD"], p_cid_id, player_side);
    if (!confirmed) return;
    let success;
    if (player_side == 1) {
       success = await get_card_to(
          player1_board.CARD_IN_HAND,
          player1_board.CARD_IN_BOARD,
          p_cid_id
      );
    }else{
       success = await get_card_to(
          player2_board.CARD_IN_HAND,
          player2_board.CARD_IN_BOARD,
          p_cid_id
      );
    }
    if (success) {
        load_card(player_side);
        close_dialog();
    }
}

function set_mirage(p_cid_id,player_side){
  let success;
  if(player_side == 1){
     success = get_card_to(
        player1_board.CARD_IN_HAND,
        player1_board.CARD_IN_MIRAGE,
        p_cid_id
    );  
  }else{
     success = get_card_to(
        player2_board.CARD_IN_HAND,
        player2_board.CARD_IN_MIRAGE,
        p_cid_id
    );  
  }
    
    if (success) {
        load_card(player_side);
        close_dialog();
    }
}

function set_burst(p_cid_id,player_side){
    let success;
    if(player_side == 1){
    success = get_card_to(
        player1_board.CARD_IN_HAND,
        player1_board.CARD_IN_BURST,
        p_cid_id
    );  
  }else{
    success = get_card_to(
        player2_board.CARD_IN_HAND,
        player2_board.CARD_IN_BURST,
        p_cid_id
    );  
  }
    if (success) {
        load_card(player_side);
        close_dialog();
    }
}

function set_GY(p_get_from,p_cid_id,player_side) {
  let success;
  if(player_side == 1){
     success = get_card_to(
        p_get_from,
        player1_board.CARD_IN_GY,
        p_cid_id
    );  
  }else{
     success = get_card_to(
        p_get_from,
        player2_board.CARD_IN_GY,
        p_cid_id
    );  
  }
    if (success) {
        load_card();
        close_dialog();
    }
    // load_card();
}

function use_skill(p_raw_code){
    let fn = new Function(p_raw_code);
    fn();
    close_dialog();
}

function flip_coin(p_side) {
  var flipResult = Math.random();
  var coin = document.getElementById('coin');
  coin.classList.remove('heads');
  coin.classList.remove('tails');
  document.getElementById("Dialog_detail").removeChild(document.getElementById("Dialog_detail").lastChild);
    setTimeout(function(){
      if(flipResult <= 0.5){
        coin.classList.add('heads');
        coin_result = 'HEAD';
      }
      else{
        coin.classList.add('tails');
        coin_result = 'TAIL';
      }
    }, 100);
    setTimeout(function(){
      let result = '';
      if(p_side){
          if(p_side == coin_result) result = "คุณทายถูก";
          else result = "คุณทายผิด";
      }
      // document.getElementById("Dialog_detail").appendChild(document.createElement("p")).innerText = "ผลการทอยเหรียญ = " + coin_result + " (" + result + ")";
      const button_container = document.createElement("div"); button_container.classList.add("button-container");
      const First = document.createElement("button"); First.onclick = function(){ sel_turn('FIRST'); }; First.innerText = "First";
      const Second = document.createElement("button"); Second.onclick = function(){ sel_turn('LAST'); }; Second.innerText = "Second";
      button_container.appendChild(First); button_container.appendChild(Second);
      document.getElementById("Dialog_title").innerText = "เลือกเล่นก่อนหรือหลัง ?";
      document.getElementById("Dialog_detail").appendChild(button_container);
    }, 3100);
}
function sel_turn(p_side) {
    start_game();
    close_dialog();
}

function get_img(p_card_image){
    return 'images/'+p_card_image+'.webp';
}

async function get_card_to(p_list_card_from, p_list_card_to, p_cid_id){
  return new Promise((resolve) => {
    const index = p_list_card_from.findIndex(card => card.cid_id == p_cid_id);
    if (index > -1) { 
      p_list_card_to.push(p_list_card_from[index]);
      p_list_card_from.splice(index, 1); 
    }
    resolve(true);
  });
}


let test_tooltip = 0; 
document.addEventListener("DOMContentLoaded", () => {
  const tooltip = document.getElementById("tooltip");
  document.addEventListener("mousemove", (e) => {
    if ( test_tooltip > 0 ) {
        tooltip.style.display = 'block';
        tooltip.style.left = e.clientX + "px";
        tooltip.style.top  = e.clientY + "px";
    }else{
        tooltip.style.display = 'none';
    }
  });
});
